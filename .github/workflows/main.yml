name: Microservices CI/CD – EKS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read  # Only need checkout permissions now

env:
  AWS_REGION: us-east-1
  ECR_ACCOUNT: "168377603278"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3️⃣ Login to Amazon ECR
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # 4️⃣ Build & push Docker images
      - name: Build and push Docker images
        run: |
          SERVICES=("accounts" "auth" "notifications" "transactions")
          for SERVICE in "${SERVICES[@]}"; do
            IMAGE_TAG=$(date +%Y%m%d%H%M%S)
            IMAGE_URI=$ECR_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com/$SERVICE:$IMAGE_TAG

            echo "Building $SERVICE..."
            docker build -t $IMAGE_URI ./$SERVICE

            echo "Pushing $SERVICE to ECR..."
            docker push $IMAGE_URI

            # Export for later steps
            echo "IMAGE_URI_${SERVICE}=$IMAGE_URI" >> $GITHUB_ENV
          done

      # 5️⃣ Set up kubectl
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.30.0'

      # 6️⃣ Configure kubeconfig for EKS
      - name: Configure kubeconfig
        run: |
          aws eks update-kubeconfig --region $AWS_REGION --name eks-banking-cluster

      # 7️⃣ Test EKS access
      - name: Test EKS access
        run: |
          kubectl config view
          kubectl get nodes

      # 8️⃣ Deploy microservices
      - name: Deploy microservices
        run: |
          DEPLOYMENTS=("accounts-service" "auth-service" "transactions-service")
          
          for DEPLOYMENT in "${DEPLOYMENTS[@]}"; do
            CONTAINER_NAME="${DEPLOYMENT%-service}"
            IMAGE_VAR="IMAGE_URI_${CONTAINER_NAME}"
            IMAGE_URI="${!IMAGE_VAR}"

            echo "Deploying $DEPLOYMENT using container $CONTAINER_NAME with image $IMAGE_URI..."
            
            # Update deployment image
            kubectl set image deployment/$DEPLOYMENT $CONTAINER_NAME=$IMAGE_URI -n default

            # Wait for rollout to complete
            kubectl rollout status deployment/$DEPLOYMENT --timeout=5m || exit 1
          done
